# 更新规范 - 将知识沉淀到规范中

当你学到有价值的东西（从调试、实现或讨论中），使用此命令更新相关的规范文档。

**时机**：完成任务、修复 bug 或发现新模式后

---

## 何时更新规范

| 触发条件 | 示例 | 目标规范 |
||---------|---------|-------------|
| **修复了 bug** | 发现了错误处理的细微问题 | `backend/error-handling.md` |
| **发现了模式** | 找到了更好的代码结构方式 | 相关规范文件 |
| **踩了坑** | 了解到 X 必须在 Y 之前完成 | 相关规范 + "常见错误"章节 |
| **建立了规范** | 团队同意了命名模式 | `quality-guidelines.md` |
| **跨层洞察** | 理解了数据如何在各层之间流动 | `guides/cross-layer-thinking-guide.md` |

---

## 规范结构概览

```
.trellis/spec/
├── backend/           # 后端开发标准
│   ├── index.md       # 概览和链接
│   └── *.md           # 特定主题的规范
├── frontend/          # 前端开发标准
│   ├── index.md       # 概览和链接
│   └── *.md           # 特定主题的规范
└── guides/            # 思考指南
    ├── index.md       # 指南索引
    └── *.md           # 特定主题的指南
```

---

## 更新流程

### 步骤 1: 识别你学到了什么

回答这些问题：

1. **你学到了什么？**（具体说明）
2. **为什么重要？**（它防止什么问题？）
3. **它属于哪里？**（哪个规范文件？）

### 步骤 2: 分类更新类型

| 类型 | 描述 | 操作 |
||------|-------------|--------|
| **新模式** | 发现的可复用方法 | 添加到"模式"章节 |
| **禁止模式** | 导致问题的做法 | 添加到"反模式"或"不要"章节 |
| **常见错误** | 容易犯的错误 | 添加到"常见错误"章节 |
| **规范** | 约定的标准 | 添加到相关章节 |
| **陷阱** | 不明显的行为 | 添加警告说明 |

### 步骤 3: 阅读目标规范

编辑前，阅读当前规范以：
- 理解现有结构
- 避免重复内容
- 找到正确的章节来添加更新

```bash
cat .trellis/spec/<类别>/<文件>.md
```

### 步骤 4: 进行更新

遵循这些原则：

1. **具体**：包含具体示例，而不只是抽象规则
2. **解释原因**：说明这防止什么问题
3. **展示代码**：为模式添加代码片段
4. **保持简短**：每个章节一个概念

### 步骤 5: 更新索引（如需要）

如果添加了新章节或规范状态改变，更新该类别的 `index.md`。

---

## 更新模板

### 添加新模式

```markdown
### 模式名称

**问题**：这解决什么问题？

**解决方案**：方法的简要描述。

**示例**：
\`\`\`
// 好
代码示例

// 不好
代码示例
\`\`\`

**原因**：解释为什么这样更好。
```

### 添加禁止模式

```markdown
### 不要: 模式名称

**问题**：
\`\`\`
// 不要这样做
不好的代码示例
\`\`\`

**为什么不好**：问题的解释。

**替代方案**：
\`\`\`
// 改为这样做
好的代码示例
\`\`\`
```

### 添加常见错误

```markdown
### 常见错误: 描述

**症状**：出了什么问题

**原因**：为什么会发生

**修复**：如何纠正

**预防**：如何在将来避免
```

### 添加陷阱

```markdown
> **警告**：不明显行为的简要描述。
>
> 关于何时发生以及如何处理的详细信息。
```

---

## 交互模式

如果不确定要更新什么，回答这些提示：

1. **你刚完成了什么？**
   - [ ] 修复了 bug
   - [ ] 实现了功能
   - [ ] 重构了代码
   - [ ] 讨论了方法

2. **什么让你惊讶或不明显？**
   - （描述洞察）

3. **这会帮助其他人避免同样的问题吗？**
   - 是 → 继续更新规范
   - 否 → 可能不值得记录

4. **它与哪个领域相关？**
   - [ ] 后端代码
   - [ ] 前端代码
   - [ ] 跨层数据流
   - [ ] 代码组织/复用
   - [ ] 质量/测试

---

## 质量检查清单

在完成规范更新前：

- [ ] 内容是否具体且可操作？
- [ ] 是否包含代码示例？
- [ ] 是否解释了为什么，而不只是什么？
- [ ] 是否在正确的规范文件中？
- [ ] 是否与现有内容重复？
- [ ] 新团队成员能理解吗？

---

## 与其他命令的关系

```
开发流程:
  学到东西 → /trellis-update-spec → 知识沉淀
       ↑                                  ↓
  /trellis-break-loop ←──────────────────── 未来会话受益
  （深度 bug 分析）
```

- `/trellis-break-loop` - 深度分析 bug，通常揭示需要更新的规范
- `/trellis-update-spec` - 实际进行更新（本命令）
- `/trellis-finish-work` - 提醒你检查规范是否需要更新

---

## 核心理念

> **规范是活的文档。每次调试会话、每个"啊哈"时刻都是让规范更好的机会。**

目标是**机构记忆**：
- 一个人学到的，所有人都受益
- AI 在一个会话中学到的，持续到未来会话
- 错误变成文档化的护栏

# 打破循环 - 深度 Bug 分析

当调试完成时，使用此命令进行深度分析，打破"修 bug -> 忘记 -> 重复"的循环。

---

## 分析框架

从以下 5 个维度分析你刚刚修复的 bug：

### 1. 根本原因分类

这个 bug 属于哪个类别？

| 类别 | 特征 | 示例 |
|----------|-----------------|---------|
| **A. 规范缺失** | 没有文档说明如何做 | 新功能没有检查清单 |
| **B. 跨层契约** | 层之间的接口不明确 | API 返回格式与预期不同 |
| **C. 变更传播失败** | 改了一处，漏了其他 | 改了函数签名，漏了调用处 |
| **D. 测试覆盖缺口** | 单元测试通过，集成测试失败 | 单独工作正常，组合后出问题 |
| **E. 隐式假设** | 代码依赖未文档化的假设 | 时间戳秒 vs 毫秒 |

### 2. 修复失败的原因（如适用）

如果你在成功前尝试了多次修复，分析每次失败：

- **表面修复**：修复了症状，不是根本原因
- **范围不完整**：找到了根本原因，没覆盖所有情况
- **工具限制**：grep 漏了，类型检查不够严格
- **心智模型**：一直在同一层找，没想到跨层

### 3. 预防机制

什么机制可以防止这种情况再次发生？

| 类型 | 描述 | 示例 |
|------|-------------|---------|
| **文档** | 写下来让人知道 | 更新思考指南 |
| **架构** | 从结构上使错误不可能 | 类型安全的包装器 |
| **编译时** | TypeScript 严格模式，无 any | 签名变更导致编译错误 |
| **运行时** | 监控、告警、扫描 | 检测孤立实体 |
| **测试覆盖** | E2E 测试、集成测试 | 验证完整流程 |
| **代码审查** | 检查清单、PR 模板 | "你检查了 X 吗？" |

### 4. 系统性扩展

这个 bug 揭示了什么更广泛的问题？

- **类似问题**：其他地方可能存在这个问题吗？
- **设计缺陷**：是否存在根本的架构问题？
- **流程缺陷**：是否有开发流程改进点？
- **知识缺口**：团队是否缺少某些理解？

### 5. 知识沉淀

将洞察固化到系统中：

- [ ] 更新 `.trellis/spec/guides/` 思考指南
- [ ] 更新 `.trellis/spec/backend/` 或 `frontend/` 文档
- [ ] 创建问题记录（如适用）
- [ ] 创建根本修复的功能工单
- [ ] 更新检查命令（如需要）

---

## 输出格式

请以此格式输出分析：

```markdown
## Bug 分析: [简短描述]

### 1. 根本原因分类
- **类别**: [A/B/C/D/E] - [类别名称]
- **具体原因**: [详细描述]

### 2. 修复失败的原因（如适用）
1. [第一次尝试]: [失败原因]
2. [第二次尝试]: [失败原因]
...

### 3. 预防机制
| 优先级 | 机制 | 具体行动 | 状态 |
||----------|-----------|-----------------|--------|
| P0 | ... | ... | TODO/DONE |

### 4. 系统性扩展
- **类似问题**: [列出有类似问题的地方]
- **设计改进**: [架构层面的建议]
- **流程改进**: [开发流程的建议]

### 5. 知识沉淀
- [ ] [需要更新的文档 / 需要创建的工单]
```

---

## 核心理念

> **调试的价值不在于修复 bug，而在于让这类 bug 永远不再发生。**

三个层次的洞察：
1. **战术**：如何修复这个 bug
2. **战略**：如何防止这类 bug
3. **哲学**：如何扩展思维模式

30 分钟的分析可以节省未来 30 小时的调试时间。
